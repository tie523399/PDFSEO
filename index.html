<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Master - 專業線上PDF編輯器 | 免費PDF工具</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="PDF Master 是一款功能強大的線上PDF編輯器，提供PDF編輯、合併、分割、轉換等功能。支援10種語言，完全免費使用。">
    <meta name="keywords" content="PDF編輯器, PDF editor, PDF工具, PDF轉換, PDF合併, PDF分割, 線上PDF, 免費PDF編輯器, PDF Master">
    <meta name="author" content="PDF Master Team">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="PDF Master - 專業線上PDF編輯器">
    <meta property="og:description" content="功能強大的線上PDF編輯器，支援編輯、合併、分割、轉換等功能">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pdfmaster.com">
    <meta property="og:image" content="https://pdfmaster.com/images/og-image.png">
    <meta property="og:site_name" content="PDF Master">
    <meta property="og:locale" content="zh_TW">
    <meta property="og:locale:alternate" content="en_US">
    <meta property="og:locale:alternate" content="zh_CN">
    <meta property="og:locale:alternate" content="ja_JP">
    <meta property="og:locale:alternate" content="ko_KR">
    <meta property="og:locale:alternate" content="es_ES">
    <meta property="og:locale:alternate" content="fr_FR">
    <meta property="og:locale:alternate" content="de_DE">
    <meta property="og:locale:alternate" content="pt_BR">
    <meta property="og:locale:alternate" content="ru_RU">
    <meta property="og:locale:alternate" content="ar_SA">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PDF Master - 專業線上PDF編輯器">
    <meta name="twitter:description" content="功能強大的線上PDF編輯器，支援編輯、合併、分割、轉換等功能">
    <meta name="twitter:image" content="https://pdfmaster.com/images/twitter-card.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://pdfmaster.com">
    
    <!-- Language Alternates -->
    <link rel="alternate" hreflang="zh-TW" href="https://pdfmaster.com/zh-tw">
    <link rel="alternate" hreflang="en" href="https://pdfmaster.com/en">
    <link rel="alternate" hreflang="zh-CN" href="https://pdfmaster.com/zh-cn">
    <link rel="alternate" hreflang="ja" href="https://pdfmaster.com/ja">
    <link rel="alternate" hreflang="ko" href="https://pdfmaster.com/ko">
    <link rel="alternate" hreflang="es" href="https://pdfmaster.com/es">
    <link rel="alternate" hreflang="fr" href="https://pdfmaster.com/fr">
    <link rel="alternate" hreflang="de" href="https://pdfmaster.com/de">
    <link rel="alternate" hreflang="pt" href="https://pdfmaster.com/pt">
    <link rel="alternate" hreflang="ru" href="https://pdfmaster.com/ru">
    <link rel="alternate" hreflang="ar" href="https://pdfmaster.com/ar">
    <link rel="alternate" hreflang="hi" href="https://pdfmaster.com/hi">
    <link rel="alternate" hreflang="it" href="https://pdfmaster.com/it">
    <link rel="alternate" hreflang="nl" href="https://pdfmaster.com/nl">
    <link rel="alternate" hreflang="pl" href="https://pdfmaster.com/pl">
    <link rel="alternate" hreflang="tr" href="https://pdfmaster.com/tr">
    <link rel="alternate" hreflang="vi" href="https://pdfmaster.com/vi">
    <link rel="alternate" hreflang="th" href="https://pdfmaster.com/th">
    <link rel="alternate" hreflang="id" href="https://pdfmaster.com/id">
    <link rel="alternate" hreflang="sv" href="https://pdfmaster.com/sv">
    <link rel="alternate" hreflang="x-default" href="https://pdfmaster.com">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "PDF Master",
        "description": "專業線上PDF編輯器，提供完整的PDF處理功能",
        "url": "https://pdfmaster.com",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "2543"
        }
    }
    </script>
    
    <!-- 載入必要的庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --secondary: #34a853;
            --danger: #ea4335;
            --warning: #fbbc04;
            --dark: #202124;
            --light: #f8f9fa;
            --border: #dadce0;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-hover: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            --radius: 8px;
            --transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 頂部工具列 */
        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo i {
            font-size: 28px;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }
        
        .tool-group {
            display: flex;
            gap: 5px;
            padding: 0 10px;
            border-right: 1px solid var(--border);
        }
        
        .tool-group:last-child {
            border-right: none;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--dark);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }
        
        .tool-btn:hover {
            background: var(--light);
        }
        
        .tool-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tool-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* 主要內容區 */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* 側邊欄 */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .page-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .page-item {
            border: 2px solid transparent;
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: white;
            overflow: hidden;
        }
        
        .page-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .page-item.active {
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
        }
        
        .page-thumbnail {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .page-number {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* 編輯區域 */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e8eaed;
            position: relative;
            overflow: hidden;
        }
        
        .editor-toolbar {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .zoom-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .zoom-btn:hover {
            background: var(--light);
        }
        
        .zoom-level {
            min-width: 60px;
            text-align: center;
            font-weight: 500;
        }
        
        .canvas-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pdf-canvas-container {
            position: relative;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        #pdf-canvas {
            display: block;
        }
        
        #fabric-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        
        /* 屬性面板 */
        .properties-panel {
            width: 300px;
            background: white;
            border-left: 1px solid var(--border);
            padding: 20px;
            display: none;
            overflow-y: auto;
        }
        
        .properties-panel.active {
            display: block;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            display: block;
        }
        
        .property-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .property-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .color-picker {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* 浮動工具面板 */
        .floating-tools {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 30px;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        
        .floating-tool {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--dark);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 18px;
        }
        
        .floating-tool:hover {
            background: var(--light);
            transform: scale(1.1);
        }
        
        .floating-tool.active {
            background: var(--primary);
            color: white;
        }
        
        /* 上傳區域 */
        .upload-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 90%;
        }
        
        .upload-icon {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .upload-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .upload-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
        }
        
        .upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        #file-input {
            display: none;
        }
        
        /* 載入動畫 */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 右鍵選單 */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-hover);
            padding: 8px 0;
            min-width: 200px;
            display: none;
            z-index: 2000;
        }
        
        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .context-menu-item:hover {
            background: var(--light);
        }
        
        .context-menu-item i {
            width: 20px;
            color: #666;
        }
        
        /* 模態框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }
        
        /* 文字編輯器 */
        .text-editor {
            position: absolute;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 4px;
            padding: 5px;
            display: none;
            z-index: 1500;
        }
        
        .text-editor textarea {
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            min-width: 200px;
            min-height: 30px;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -250px;
                height: 100%;
                z-index: 1500;
                transition: left 0.3s ease;
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .properties-panel {
                position: absolute;
                right: -300px;
                height: 100%;
                z-index: 1500;
                transition: right 0.3s ease;
            }
            
            .properties-panel.mobile-open {
                right: 0;
            }
            
            .floating-tools {
                bottom: 10px;
                padding: 8px 15px;
            }
            
            .floating-tool {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
        
        /* 狀態列 */
        .status-bar {
            background: white;
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }
        
        /* 快捷鍵提示 */
        .shortcut-hint {
            background: var(--dark);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        /* 語言選擇器 */
        .language-selector {
            position: relative;
            margin-left: auto;
            margin-right: 10px;
        }
        
        .language-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .language-btn:hover {
            background: var(--light);
            border-color: var(--primary);
        }
        
        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-hover);
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .language-menu.active {
            display: block;
        }
        
        .language-menu a {
            display: block;
            padding: 10px 16px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            font-size: 14px;
        }
        
        .language-menu a:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        /* 印章樣式 */
        .stamp-preview {
            width: 100px;
            height: 100px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .stamp-preview:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .stamp-preview img {
            max-width: 90%;
            max-height: 90%;
        }
        
        /* 簽名板 */
        .signature-pad {
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: crosshair;
            margin: 10px 0;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* 圖片上傳區域 */
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .image-upload-area:hover {
            border-color: var(--primary);
            background: var(--light);
        }
        
        .image-upload-area i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        /* 新聞廣告欄 */
        .news-ticker {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1a73e8 0%, #34a853 50%, #fbbc04 100%);
            color: white;
            padding: 10px 20px;
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .news-ticker-content {
            display: flex;
            align-items: center;
            flex: 1;
            overflow: hidden;
        }
        
        .news-label {
            font-weight: bold;
            margin-right: 20px;
            white-space: nowrap;
        }
        
        .news-items {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 20px;
        }
        
        .news-item {
            position: absolute;
            white-space: nowrap;
            animation: newsScroll 20s linear infinite;
        }
        
        @keyframes newsScroll {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        .news-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .news-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* 調整主體內容，為新聞欄留出空間 */
        body.news-active {
            padding-top: 50px;
        }
        
        /* Bot 面板 */
        .bot-panel {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 350px;
            max-height: 600px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        
        .bot-panel.active {
            display: flex;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .bot-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .bot-minimize {
            margin-left: auto;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .bot-minimize:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .bot-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .bot-section {
            margin-bottom: 25px;
        }
        
        .bot-section h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 16px;
        }
        
        .bot-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .bot-btn {
            background: var(--light);
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--dark);
        }
        
        .bot-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .bot-btn i {
            font-size: 16px;
        }
        
        /* Bot 觸發按鈕 */
        .bot-trigger {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition);
            z-index: 2999;
        }
        
        .bot-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .bot-trigger:active {
            transform: scale(0.95);
        }
        
        /* 新聞管理模態框 */
        .news-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow-hover);
            z-index: 5000;
            max-width: 500px;
            width: 90%;
            display: none;
        }
        
        .news-modal.active {
            display: block;
        }
        
        .news-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .news-form input,
        .news-form textarea {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: inherit;
        }
        
        .news-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* 廣告橫幅 */
        .ad-banner {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            padding: 15px 30px;
            box-shadow: var(--shadow-hover);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2000;
        }
        
        .ad-banner.active {
            display: flex;
        }
        
        .ad-banner-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ad-banner-close {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- 頭部工具列 -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-file-pdf"></i>
            PDF Master
        </div>
        
        <div class="toolbar">
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="openFile" onclick="openFile()">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="tool-btn" data-tooltip="save" onclick="savePDF()">
                    <i class="fas fa-save"></i>
                </button>
                <button class="tool-btn" data-tooltip="export" onclick="exportPDF()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="undo" onclick="undo()">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="tool-btn" data-tooltip="redo" onclick="redo()">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="cut" onclick="cut()">
                    <i class="fas fa-cut"></i>
                </button>
                <button class="tool-btn" data-tooltip="copy" onclick="copy()">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="tool-btn" data-tooltip="paste" onclick="paste()">
                    <i class="fas fa-paste"></i>
                </button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="addPage" onclick="addPage()">
                    <i class="fas fa-plus-circle"></i>
                </button>
                <button class="tool-btn" data-tooltip="deletePage" onclick="deletePage()">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="tool-btn" data-tooltip="reorderPages" onclick="reorderPages()">
                    <i class="fas fa-sort"></i>
                </button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="rotatePage" onclick="rotatePage(90)">
                    <i class="fas fa-redo-alt"></i>
                </button>
                <button class="tool-btn" data-tooltip="extractText" onclick="extractText()">
                    <i class="fas fa-file-alt"></i>
                </button>
                <button class="tool-btn" data-tooltip="addWatermark" onclick="addWatermark()">
                    <i class="fas fa-tint"></i>
                </button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" data-tooltip="mergePDF" onclick="mergePDFs()">
                    <i class="fas fa-object-group"></i>
                </button>
                <button class="tool-btn" data-tooltip="splitPDF" onclick="splitPDF()">
                    <i class="fas fa-cut"></i>
                </button>
            </div>
        </div>
        
        <button class="tool-btn" data-tooltip="settings" onclick="openSettings()">
            <i class="fas fa-cog"></i>
        </button>
        
        <!-- 語言選擇器 -->
        <div class="language-selector">
            <button class="language-btn" onclick="toggleLanguageMenu()">
                <i class="fas fa-globe"></i>
                <span id="current-lang">繁體中文</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="language-menu" id="language-menu">
                <a href="#" onclick="changeLanguage('zh-TW')">🇹🇼 繁體中文</a>
                <a href="#" onclick="changeLanguage('en')">🇺🇸 English</a>
                <a href="#" onclick="changeLanguage('zh-CN')">🇨🇳 简体中文</a>
                <a href="#" onclick="changeLanguage('ja')">🇯🇵 日本語</a>
                <a href="#" onclick="changeLanguage('ko')">🇰🇷 한국어</a>
                <a href="#" onclick="changeLanguage('es')">🇪🇸 Español</a>
                <a href="#" onclick="changeLanguage('fr')">🇫🇷 Français</a>
                <a href="#" onclick="changeLanguage('de')">🇩🇪 Deutsch</a>
                <a href="#" onclick="changeLanguage('pt')">🇧🇷 Português</a>
                <a href="#" onclick="changeLanguage('ru')">🇷🇺 Русский</a>
                <a href="#" onclick="changeLanguage('ar')">🇸🇦 العربية</a>
                <a href="#" onclick="changeLanguage('hi')">🇮🇳 हिन्दी</a>
                <a href="#" onclick="changeLanguage('it')">🇮🇹 Italiano</a>
                <a href="#" onclick="changeLanguage('nl')">🇳🇱 Nederlands</a>
                <a href="#" onclick="changeLanguage('pl')">🇵🇱 Polski</a>
                <a href="#" onclick="changeLanguage('tr')">🇹🇷 Türkçe</a>
                <a href="#" onclick="changeLanguage('vi')">🇻🇳 Tiếng Việt</a>
                <a href="#" onclick="changeLanguage('th')">🇹🇭 ไทย</a>
                <a href="#" onclick="changeLanguage('id')">🇮🇩 Bahasa Indonesia</a>
                <a href="#" onclick="changeLanguage('sv')">🇸🇪 Svenska</a>
            </div>
        </div>
    </header>
    
    <!-- 主要容器 -->
    <div class="main-container">
        <!-- 側邊欄 - 頁面縮圖 -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title" data-i18n="pages">頁面</h3>
            </div>
            <div class="page-list" id="page-list">
                <!-- 頁面縮圖將動態插入這裡 -->
            </div>
        </aside>
        
        <!-- 編輯區域 -->
        <main class="editor-container">
            <!-- 編輯器工具列 -->
            <div class="editor-toolbar">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="zoom-btn" onclick="fitToPage()">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                
                <div class="page-navigation">
                    <button class="zoom-btn" onclick="previousPage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info">1 / 1</span>
                    <button class="zoom-btn" onclick="nextPage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Canvas 包裝器 -->
            <div class="canvas-wrapper" id="canvas-wrapper">
                <!-- 上傳區域 -->
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h2 class="upload-title" data-i18n="uploadPDF">上傳PDF檔案</h2>
                    <p class="upload-subtitle" data-i18n="dragDropFile">拖放檔案到此處或點擊選擇檔案</p>
                    <label for="file-input" class="upload-btn" data-i18n="selectFile">選擇檔案</label>
                    <input type="file" id="file-input" accept=".pdf" onchange="handleFileSelect(event)">
                </div>
                
                <!-- PDF Canvas -->
                <div class="pdf-canvas-container" id="pdf-canvas-container" style="display: none;">
                    <canvas id="pdf-canvas"></canvas>
                    <canvas id="fabric-canvas"></canvas>
                </div>
                
                <!-- 載入動畫 -->
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p data-i18n="loading">正在載入PDF...</p>
                </div>
            </div>
        </main>
        
        <!-- 屬性面板 -->
        <aside class="properties-panel" id="properties-panel">
            <h3 style="margin-bottom: 20px;" data-i18n="properties">屬性</h3>
            
            <div class="property-group">
                <label class="property-label" data-i18n="fillColor">填充顏色</label>
                <input type="color" class="color-picker" id="fill-color" onchange="updateObjectProperty('fill')">
            </div>
            
            <div class="property-group">
                <label class="property-label" data-i18n="strokeColor">邊框顏色</label>
                <input type="color" class="color-picker" id="stroke-color" onchange="updateObjectProperty('stroke')">
            </div>
            
            <div class="property-group">
                <label class="property-label" data-i18n="strokeWidth">邊框寬度</label>
                <input type="range" class="property-control" id="stroke-width" min="1" max="10" value="2" onchange="updateObjectProperty('strokeWidth')">
            </div>
            
            <div class="property-group">
                <label class="property-label" data-i18n="opacity">透明度</label>
                <input type="range" class="property-control" id="opacity" min="0" max="100" value="100" onchange="updateObjectProperty('opacity')">
            </div>
            
            <div class="property-group">
                <label class="property-label" data-i18n="fontSize">字體大小</label>
                <input type="number" class="property-control" id="font-size" min="8" max="72" value="16" onchange="updateObjectProperty('fontSize')">
            </div>
            
            <div class="property-group">
                <label class="property-label" data-i18n="fontFamily">字體</label>
                <select class="property-control" id="font-family" onchange="updateObjectProperty('fontFamily')">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
        </aside>
    </div>
    
    <!-- 浮動工具面板 -->
    <div class="floating-tools">
        <button class="floating-tool active" data-tool="select" onclick="setTool('select')" title="選擇">
            <i class="fas fa-mouse-pointer"></i>
        </button>
        <button class="floating-tool" data-tool="text" onclick="setTool('text')" title="文字">
            <i class="fas fa-font"></i>
        </button>
        <button class="floating-tool" data-tool="draw" onclick="setTool('draw')" title="繪圖">
            <i class="fas fa-pencil-alt"></i>
        </button>
        <button class="floating-tool" data-tool="shape" onclick="setTool('shape')" title="形狀">
            <i class="fas fa-shapes"></i>
        </button>
        <button class="floating-tool" data-tool="image" onclick="setTool('image')" title="圖片">
            <i class="fas fa-image"></i>
        </button>
        <button class="floating-tool" data-tool="highlight" onclick="setTool('highlight')" title="螢光筆">
            <i class="fas fa-highlighter"></i>
        </button>
        <button class="floating-tool" data-tool="stamp" onclick="setTool('stamp')" title="印章">
            <i class="fas fa-stamp"></i>
        </button>
        <button class="floating-tool" data-tool="signature" onclick="setTool('signature')" title="簽名">
            <i class="fas fa-signature"></i>
        </button>
    </div>
    
    <!-- 新聞廣告欄 -->
    <div class="news-ticker" id="news-ticker">
        <div class="news-ticker-content">
            <span class="news-label">📢 最新消息：</span>
            <div class="news-items" id="news-items">
                <span class="news-item active">歡迎使用 PDF Master - 您的專業 PDF 編輯助手！</span>
            </div>
        </div>
        <button class="news-close" onclick="toggleNewsTicker()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- 狀態列 -->
    <div class="status-bar">
        <div>
            <span id="status-message">就緒</span>
        </div>
        <div>
            <span>Ctrl+Z 復原</span>
            <span style="margin-left: 10px;">Ctrl+S 儲存</span>
            <span style="margin-left: 10px;">Ctrl+O 開啟</span>
        </div>
    </div>
    
    <!-- 管理機器人面板 -->
    <div class="bot-panel" id="bot-panel">
        <div class="bot-header">
            <i class="fas fa-robot"></i>
            <span>PDF Bot 管理助手</span>
            <button class="bot-minimize" onclick="toggleBotPanel()">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div class="bot-body">
            <div class="bot-section">
                <h4>📰 新聞管理</h4>
                <div class="bot-buttons">
                    <button class="bot-btn" onclick="botAction('addNews')">
                        <i class="fas fa-plus"></i> 新增新聞
                    </button>
                    <button class="bot-btn" onclick="botAction('editNews')">
                        <i class="fas fa-edit"></i> 編輯新聞
                    </button>
                    <button class="bot-btn" onclick="botAction('deleteNews')">
                        <i class="fas fa-trash"></i> 刪除新聞
                    </button>
                    <button class="bot-btn" onclick="botAction('scheduleNews')">
                        <i class="fas fa-clock"></i> 排程發布
                    </button>
                </div>
            </div>
            
            <div class="bot-section">
                <h4>📊 廣告管理</h4>
                <div class="bot-buttons">
                    <button class="bot-btn" onclick="botAction('addAd')">
                        <i class="fas fa-ad"></i> 新增廣告
                    </button>
                    <button class="bot-btn" onclick="botAction('adStats')">
                        <i class="fas fa-chart-bar"></i> 廣告統計
                    </button>
                    <button class="bot-btn" onclick="botAction('adSettings')">
                        <i class="fas fa-cog"></i> 廣告設定
                    </button>
                    <button class="bot-btn" onclick="botAction('adRevenue')">
                        <i class="fas fa-dollar-sign"></i> 收益報告
                    </button>
                </div>
            </div>
            
            <div class="bot-section">
                <h4>🔧 系統功能</h4>
                <div class="bot-buttons">
                    <button class="bot-btn" onclick="botAction('analytics')">
                        <i class="fas fa-analytics"></i> 數據分析
                    </button>
                    <button class="bot-btn" onclick="botAction('userManage')">
                        <i class="fas fa-users"></i> 用戶管理
                    </button>
                    <button class="bot-btn" onclick="botAction('backup')">
                        <i class="fas fa-database"></i> 備份還原
                    </button>
                    <button class="bot-btn" onclick="botAction('apiKeys')">
                        <i class="fas fa-key"></i> API 金鑰
                    </button>
                </div>
            </div>
            
            <div class="bot-section">
                <h4>🤖 Bot 設定</h4>
                <div class="bot-buttons">
                    <button class="bot-btn" onclick="botAction('autoReply')">
                        <i class="fas fa-reply"></i> 自動回覆
                    </button>
                    <button class="bot-btn" onclick="botAction('botSchedule')">
                        <i class="fas fa-calendar"></i> 排程任務
                    </button>
                    <button class="bot-btn" onclick="botAction('botLogs')">
                        <i class="fas fa-file-alt"></i> 操作日誌
                    </button>
                    <button class="bot-btn" onclick="botAction('botSettings')">
                        <i class="fas fa-sliders-h"></i> Bot 設定
                    </button>
                </div>
            </div>
            
            <div class="bot-section">
                <h4>📱 Telegram Bot</h4>
                <div class="bot-buttons">
                    <button class="bot-btn" onclick="botAction('telegramConnect')">
                        <i class="fab fa-telegram"></i> 連接 Bot
                    </button>
                    <button class="bot-btn" onclick="botAction('telegramBroadcast')">
                        <i class="fas fa-broadcast-tower"></i> 廣播訊息
                    </button>
                    <button class="bot-btn" onclick="botAction('telegramStats')">
                        <i class="fas fa-chart-line"></i> Bot 統計
                    </button>
                    <button class="bot-btn" onclick="botAction('telegramSettings')">
                        <i class="fas fa-cogs"></i> Bot 設定
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot 觸發按鈕 -->
    <button class="bot-trigger" onclick="toggleBotPanel()" title="開啟管理機器人">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- 右鍵選單 -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextAction('cut')">
            <i class="fas fa-cut"></i>
            <span data-i18n="cut">剪下</span>
        </div>
        <div class="context-menu-item" onclick="contextAction('copy')">
            <i class="fas fa-copy"></i>
            <span data-i18n="copy">複製</span>
        </div>
        <div class="context-menu-item" onclick="contextAction('paste')">
            <i class="fas fa-paste"></i>
            <span data-i18n="paste">貼上</span>
        </div>
        <div class="context-menu-item" onclick="contextAction('delete')">
            <i class="fas fa-trash"></i>
            <span data-i18n="delete">刪除</span>
        </div>
        <div class="context-menu-item" onclick="contextAction('bringToFront')">
            <i class="fas fa-layer-group"></i>
            <span data-i18n="bringToFront">移到最上層</span>
        </div>
        <div class="context-menu-item" onclick="contextAction('sendToBack')">
            <i class="fas fa-layer-group"></i>
            <span data-i18n="sendToBack">移到最下層</span>
        </div>
    </div>
    
    <!-- 文字編輯器 -->
    <div class="text-editor" id="text-editor">
        <textarea id="text-editor-input"></textarea>
    </div>
    
    <!-- 圖片上傳模態框 -->
    <div class="modal" id="image-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span data-i18n="uploadImage">上傳圖片</span>
            </div>
            <div class="modal-body">
                <div class="image-upload-area" onclick="document.getElementById('image-file-input').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p data-i18n="dragDropImage">拖放圖片到此處或點擊選擇</p>
                    <input type="file" id="image-file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('image-modal')" data-i18n="cancel">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 印章選擇模態框 -->
    <div class="modal" id="stamp-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span data-i18n="selectStamp">選擇印章</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div class="stamp-preview" onclick="addStamp('approved')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#4CAF50" stroke-width="3"/>
                            <text x="50" y="40" text-anchor="middle" fill="#4CAF50" font-size="16" font-weight="bold">APPROVED</text>
                            <text x="50" y="60" text-anchor="middle" fill="#4CAF50" font-size="12">已批准</text>
                        </svg>
                    </div>
                    <div class="stamp-preview" onclick="addStamp('rejected')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#F44336" stroke-width="3"/>
                            <text x="50" y="40" text-anchor="middle" fill="#F44336" font-size="16" font-weight="bold">REJECTED</text>
                            <text x="50" y="60" text-anchor="middle" fill="#F44336" font-size="12">已拒絕</text>
                        </svg>
                    </div>
                    <div class="stamp-preview" onclick="addStamp('confidential')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <rect x="10" y="30" width="80" height="40" fill="none" stroke="#FF9800" stroke-width="3"/>
                            <text x="50" y="55" text-anchor="middle" fill="#FF9800" font-size="14" font-weight="bold">CONFIDENTIAL</text>
                        </svg>
                    </div>
                    <div class="stamp-preview" onclick="addStamp('copy')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <rect x="10" y="30" width="80" height="40" fill="none" stroke="#2196F3" stroke-width="3" transform="rotate(-15 50 50)"/>
                            <text x="50" y="55" text-anchor="middle" fill="#2196F3" font-size="18" font-weight="bold" transform="rotate(-15 50 50)">COPY</text>
                        </svg>
                    </div>
                    <div class="stamp-preview" onclick="addStamp('urgent')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <polygon points="50,10 90,80 10,80" fill="none" stroke="#F44336" stroke-width="3"/>
                            <text x="50" y="60" text-anchor="middle" fill="#F44336" font-size="16" font-weight="bold">URGENT</text>
                        </svg>
                    </div>
                    <div class="stamp-preview" onclick="addStamp('paid')">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#4CAF50" stroke-width="3"/>
                            <text x="50" y="40" text-anchor="middle" fill="#4CAF50" font-size="20" font-weight="bold">PAID</text>
                            <text x="50" y="60" text-anchor="middle" fill="#4CAF50" font-size="12">已付款</text>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('stamp-modal')" data-i18n="cancel">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 簽名模態框 -->
    <div class="modal" id="signature-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span data-i18n="drawSignature">繪製簽名</span>
            </div>
            <div class="modal-body">
                <canvas id="signature-canvas" class="signature-pad" width="400" height="200"></canvas>
                <div class="signature-controls">
                    <button class="btn btn-secondary" onclick="clearSignature()" data-i18n="clear">清除</button>
                    <input type="color" id="signature-color" value="#000000">
                    <input type="range" id="signature-width" min="1" max="10" value="2">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('signature-modal')" data-i18n="cancel">取消</button>
                <button class="btn btn-primary" onclick="saveSignature()" data-i18n="save">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- 新聞管理模態框 -->
    <div class="modal" id="news-management-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="news-modal-title">新增新聞</span>
            </div>
            <div class="modal-body">
                <form class="news-form" id="news-form">
                    <input type="text" id="news-title" placeholder="新聞標題" required>
                    <textarea id="news-content" placeholder="新聞內容" required></textarea>
                    <input type="url" id="news-link" placeholder="連結 (選填)">
                    <input type="datetime-local" id="news-schedule" placeholder="排程時間">
                    <select id="news-priority">
                        <option value="normal">一般</option>
                        <option value="important">重要</option>
                        <option value="urgent">緊急</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('news-management-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveNews()">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- 廣告管理模態框 -->
    <div class="modal" id="ad-management-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>廣告管理</span>
            </div>
            <div class="modal-body">
                <form class="news-form" id="ad-form">
                    <input type="text" id="ad-title" placeholder="廣告標題" required>
                    <textarea id="ad-description" placeholder="廣告描述" required></textarea>
                    <input type="url" id="ad-image" placeholder="圖片網址">
                    <input type="url" id="ad-link" placeholder="點擊連結" required>
                    <select id="ad-position">
                        <option value="top">頂部橫幅</option>
                        <option value="bottom">底部橫幅</option>
                        <option value="sidebar">側邊欄</option>
                        <option value="popup">彈出視窗</option>
                    </select>
                    <input type="number" id="ad-duration" placeholder="顯示時長(秒)" min="1" value="30">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('ad-management-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveAd()">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- 廣告橫幅 -->
    <div class="ad-banner" id="ad-banner">
        <div class="ad-banner-content">
            <i class="fas fa-ad" style="font-size: 24px; color: var(--primary);"></i>
            <div>
                <strong id="ad-banner-title">限時優惠！</strong>
                <span id="ad-banner-text">升級到專業版享受更多功能</span>
            </div>
        </div>
        <button class="ad-banner-close" onclick="closeAdBanner()">關閉</button>
    </div>

    <script>
        // PDF.js 全域設定
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // 多語言翻譯系統
        const translations = {
            'zh-TW': {
                appName: 'PDF Master',
                openFile: '開啟檔案',
                save: '儲存',
                export: '匯出',
                undo: '復原',
                redo: '重做',
                cut: '剪下',
                copy: '複製',
                paste: '貼上',
                addPage: '新增頁面',
                deletePage: '刪除頁面',
                reorderPages: '頁面順序',
                settings: '設定',
                pages: '頁面',
                uploadPDF: '上傳PDF檔案',
                dragDropFile: '拖放檔案到此處或點擊選擇檔案',
                selectFile: '選擇檔案',
                loading: '正在載入PDF...',
                properties: '屬性',
                fillColor: '填充顏色',
                strokeColor: '邊框顏色',
                strokeWidth: '邊框寬度',
                opacity: '透明度',
                fontSize: '字體大小',
                fontFamily: '字體',
                select: '選擇',
                text: '文字',
                draw: '繪圖',
                shape: '形狀',
                image: '圖片',
                highlight: '螢光筆',
                stamp: '印章',
                signature: '簽名',
                uploadImage: '上傳圖片',
                dragDropImage: '拖放圖片到此處或點擊選擇',
                selectStamp: '選擇印章',
                drawSignature: '繪製簽名',
                clear: '清除',
                cancel: '取消',
                ok: '確定',
                delete: '刪除',
                bringToFront: '移到最上層',
                sendToBack: '移到最下層',
                ready: '就緒',
                page: '第',
                pageOf: '頁'
            },
            'en': {
                appName: 'PDF Master',
                openFile: 'Open File',
                save: 'Save',
                export: 'Export',
                undo: 'Undo',
                redo: 'Redo',
                cut: 'Cut',
                copy: 'Copy',
                paste: 'Paste',
                addPage: 'Add Page',
                deletePage: 'Delete Page',
                reorderPages: 'Reorder Pages',
                settings: 'Settings',
                pages: 'Pages',
                uploadPDF: 'Upload PDF File',
                dragDropFile: 'Drag and drop file here or click to select',
                selectFile: 'Select File',
                loading: 'Loading PDF...',
                properties: 'Properties',
                fillColor: 'Fill Color',
                strokeColor: 'Stroke Color',
                strokeWidth: 'Stroke Width',
                opacity: 'Opacity',
                fontSize: 'Font Size',
                fontFamily: 'Font Family',
                select: 'Select',
                text: 'Text',
                draw: 'Draw',
                shape: 'Shape',
                image: 'Image',
                highlight: 'Highlight',
                stamp: 'Stamp',
                signature: 'Signature',
                uploadImage: 'Upload Image',
                dragDropImage: 'Drag and drop image here or click to select',
                selectStamp: 'Select Stamp',
                drawSignature: 'Draw Signature',
                clear: 'Clear',
                cancel: 'Cancel',
                ok: 'OK',
                delete: 'Delete',
                bringToFront: 'Bring to Front',
                sendToBack: 'Send to Back',
                ready: 'Ready',
                page: 'Page',
                pageOf: 'of'
            },
            'zh-CN': {
                appName: 'PDF Master',
                openFile: '打开文件',
                save: '保存',
                export: '导出',
                undo: '撤销',
                redo: '重做',
                cut: '剪切',
                copy: '复制',
                paste: '粘贴',
                addPage: '添加页面',
                deletePage: '删除页面',
                reorderPages: '页面顺序',
                settings: '设置',
                pages: '页面',
                uploadPDF: '上传PDF文件',
                dragDropFile: '拖放文件到此处或点击选择文件',
                selectFile: '选择文件',
                loading: '正在加载PDF...',
                properties: '属性',
                fillColor: '填充颜色',
                strokeColor: '边框颜色',
                strokeWidth: '边框宽度',
                opacity: '透明度',
                fontSize: '字体大小',
                fontFamily: '字体',
                select: '选择',
                text: '文字',
                draw: '绘图',
                shape: '形状',
                image: '图片',
                highlight: '荧光笔',
                stamp: '印章',
                signature: '签名',
                uploadImage: '上传图片',
                dragDropImage: '拖放图片到此处或点击选择',
                selectStamp: '选择印章',
                drawSignature: '绘制签名',
                clear: '清除',
                cancel: '取消',
                ok: '确定',
                delete: '删除',
                bringToFront: '移到最上层',
                sendToBack: '移到最下层',
                ready: '就绪',
                page: '第',
                pageOf: '页'
            },
            'ja': {
                appName: 'PDF Master',
                openFile: 'ファイルを開く',
                save: '保存',
                export: 'エクスポート',
                undo: '元に戻す',
                redo: 'やり直し',
                cut: '切り取り',
                copy: 'コピー',
                paste: '貼り付け',
                addPage: 'ページを追加',
                deletePage: 'ページを削除',
                reorderPages: 'ページの順序',
                settings: '設定',
                pages: 'ページ',
                uploadPDF: 'PDFファイルをアップロード',
                dragDropFile: 'ここにファイルをドラッグ＆ドロップまたはクリックして選択',
                selectFile: 'ファイルを選択',
                loading: 'PDFを読み込み中...',
                properties: 'プロパティ',
                fillColor: '塗りつぶし色',
                strokeColor: '線の色',
                strokeWidth: '線の幅',
                opacity: '不透明度',
                fontSize: 'フォントサイズ',
                fontFamily: 'フォント',
                select: '選択',
                text: 'テキスト',
                draw: '描画',
                shape: '図形',
                image: '画像',
                highlight: '蛍光ペン',
                stamp: 'スタンプ',
                signature: '署名',
                uploadImage: '画像をアップロード',
                dragDropImage: 'ここに画像をドラッグ＆ドロップまたはクリックして選択',
                selectStamp: 'スタンプを選択',
                drawSignature: '署名を描く',
                clear: 'クリア',
                cancel: 'キャンセル',
                ok: 'OK',
                delete: '削除',
                bringToFront: '最前面へ',
                sendToBack: '最背面へ',
                ready: '準備完了',
                page: 'ページ',
                pageOf: '/'
            },
            'ko': {
                appName: 'PDF Master',
                openFile: '파일 열기',
                save: '저장',
                export: '내보내기',
                undo: '실행 취소',
                redo: '다시 실행',
                cut: '잘라내기',
                copy: '복사',
                paste: '붙여넣기',
                addPage: '페이지 추가',
                deletePage: '페이지 삭제',
                reorderPages: '페이지 순서',
                settings: '설정',
                pages: '페이지',
                uploadPDF: 'PDF 파일 업로드',
                dragDropFile: '여기에 파일을 드래그 앤 드롭하거나 클릭하여 선택',
                selectFile: '파일 선택',
                loading: 'PDF 로딩 중...',
                properties: '속성',
                fillColor: '채우기 색상',
                strokeColor: '테두리 색상',
                strokeWidth: '테두리 너비',
                opacity: '불투명도',
                fontSize: '글꼴 크기',
                fontFamily: '글꼴',
                select: '선택',
                text: '텍스트',
                draw: '그리기',
                shape: '도형',
                image: '이미지',
                highlight: '형광펜',
                stamp: '스탬프',
                signature: '서명',
                uploadImage: '이미지 업로드',
                dragDropImage: '여기에 이미지를 드래그 앤 드롭하거나 클릭하여 선택',
                selectStamp: '스탬프 선택',
                drawSignature: '서명 그리기',
                clear: '지우기',
                cancel: '취소',
                ok: '확인',
                delete: '삭제',
                bringToFront: '맨 앞으로',
                sendToBack: '맨 뒤로',
                ready: '준비',
                page: '페이지',
                pageOf: '/'
            },
            'es': {
                appName: 'PDF Master',
                openFile: 'Abrir archivo',
                save: 'Guardar',
                export: 'Exportar',
                undo: 'Deshacer',
                redo: 'Rehacer',
                cut: 'Cortar',
                copy: 'Copiar',
                paste: 'Pegar',
                addPage: 'Añadir página',
                deletePage: 'Eliminar página',
                reorderPages: 'Ordenar páginas',
                settings: 'Configuración',
                pages: 'Páginas',
                uploadPDF: 'Subir archivo PDF',
                dragDropFile: 'Arrastra y suelta el archivo aquí o haz clic para seleccionar',
                selectFile: 'Seleccionar archivo',
                loading: 'Cargando PDF...',
                properties: 'Propiedades',
                fillColor: 'Color de relleno',
                strokeColor: 'Color del borde',
                strokeWidth: 'Ancho del borde',
                opacity: 'Opacidad',
                fontSize: 'Tamaño de fuente',
                fontFamily: 'Fuente',
                select: 'Seleccionar',
                text: 'Texto',
                draw: 'Dibujar',
                shape: 'Forma',
                image: 'Imagen',
                highlight: 'Resaltador',
                stamp: 'Sello',
                signature: 'Firma',
                uploadImage: 'Subir imagen',
                dragDropImage: 'Arrastra y suelta la imagen aquí o haz clic para seleccionar',
                selectStamp: 'Seleccionar sello',
                drawSignature: 'Dibujar firma',
                clear: 'Limpiar',
                cancel: 'Cancelar',
                ok: 'Aceptar',
                delete: 'Eliminar',
                bringToFront: 'Traer al frente',
                sendToBack: 'Enviar atrás',
                ready: 'Listo',
                page: 'Página',
                pageOf: 'de'
            },
            'fr': {
                appName: 'PDF Master',
                openFile: 'Ouvrir le fichier',
                save: 'Enregistrer',
                export: 'Exporter',
                undo: 'Annuler',
                redo: 'Rétablir',
                cut: 'Couper',
                copy: 'Copier',
                paste: 'Coller',
                addPage: 'Ajouter une page',
                deletePage: 'Supprimer la page',
                reorderPages: 'Ordre des pages',
                settings: 'Paramètres',
                pages: 'Pages',
                uploadPDF: 'Télécharger un fichier PDF',
                dragDropFile: 'Glissez-déposez le fichier ici ou cliquez pour sélectionner',
                selectFile: 'Sélectionner un fichier',
                loading: 'Chargement du PDF...',
                properties: 'Propriétés',
                fillColor: 'Couleur de remplissage',
                strokeColor: 'Couleur du contour',
                strokeWidth: 'Largeur du contour',
                opacity: 'Opacité',
                fontSize: 'Taille de police',
                fontFamily: 'Police',
                select: 'Sélectionner',
                text: 'Texte',
                draw: 'Dessiner',
                shape: 'Forme',
                image: 'Image',
                highlight: 'Surligneur',
                stamp: 'Tampon',
                signature: 'Signature',
                uploadImage: 'Télécharger une image',
                dragDropImage: 'Glissez-déposez l\'image ici ou cliquez pour sélectionner',
                selectStamp: 'Sélectionner un tampon',
                drawSignature: 'Dessiner la signature',
                clear: 'Effacer',
                cancel: 'Annuler',
                ok: 'OK',
                delete: 'Supprimer',
                bringToFront: 'Mettre au premier plan',
                sendToBack: 'Mettre à l\'arrière-plan',
                ready: 'Prêt',
                page: 'Page',
                pageOf: 'sur'
            },
            'de': {
                appName: 'PDF Master',
                openFile: 'Datei öffnen',
                save: 'Speichern',
                export: 'Exportieren',
                undo: 'Rückgängig',
                redo: 'Wiederholen',
                cut: 'Ausschneiden',
                copy: 'Kopieren',
                paste: 'Einfügen',
                addPage: 'Seite hinzufügen',
                deletePage: 'Seite löschen',
                reorderPages: 'Seitenreihenfolge',
                settings: 'Einstellungen',
                pages: 'Seiten',
                uploadPDF: 'PDF-Datei hochladen',
                dragDropFile: 'Datei hier ablegen oder klicken zum Auswählen',
                selectFile: 'Datei auswählen',
                loading: 'PDF wird geladen...',
                properties: 'Eigenschaften',
                fillColor: 'Füllfarbe',
                strokeColor: 'Rahmenfarbe',
                strokeWidth: 'Rahmenbreite',
                opacity: 'Deckkraft',
                fontSize: 'Schriftgröße',
                fontFamily: 'Schriftart',
                select: 'Auswählen',
                text: 'Text',
                draw: 'Zeichnen',
                shape: 'Form',
                image: 'Bild',
                highlight: 'Textmarker',
                stamp: 'Stempel',
                signature: 'Unterschrift',
                uploadImage: 'Bild hochladen',
                dragDropImage: 'Bild hier ablegen oder klicken zum Auswählen',
                selectStamp: 'Stempel auswählen',
                drawSignature: 'Unterschrift zeichnen',
                clear: 'Löschen',
                cancel: 'Abbrechen',
                ok: 'OK',
                delete: 'Löschen',
                bringToFront: 'In den Vordergrund',
                sendToBack: 'In den Hintergrund',
                ready: 'Bereit',
                page: 'Seite',
                pageOf: 'von'
            },
            'pt': {
                appName: 'PDF Master',
                openFile: 'Abrir arquivo',
                save: 'Salvar',
                export: 'Exportar',
                undo: 'Desfazer',
                redo: 'Refazer',
                cut: 'Recortar',
                copy: 'Copiar',
                paste: 'Colar',
                addPage: 'Adicionar página',
                deletePage: 'Excluir página',
                reorderPages: 'Ordem das páginas',
                settings: 'Configurações',
                pages: 'Páginas',
                uploadPDF: 'Carregar arquivo PDF',
                dragDropFile: 'Arraste e solte o arquivo aqui ou clique para selecionar',
                selectFile: 'Selecionar arquivo',
                loading: 'Carregando PDF...',
                properties: 'Propriedades',
                fillColor: 'Cor de preenchimento',
                strokeColor: 'Cor da borda',
                strokeWidth: 'Largura da borda',
                opacity: 'Opacidade',
                fontSize: 'Tamanho da fonte',
                fontFamily: 'Fonte',
                select: 'Selecionar',
                text: 'Texto',
                draw: 'Desenhar',
                shape: 'Forma',
                image: 'Imagem',
                highlight: 'Marcador',
                stamp: 'Carimbo',
                signature: 'Assinatura',
                uploadImage: 'Carregar imagem',
                dragDropImage: 'Arraste e solte a imagem aqui ou clique para selecionar',
                selectStamp: 'Selecionar carimbo',
                drawSignature: 'Desenhar assinatura',
                clear: 'Limpar',
                cancel: 'Cancelar',
                ok: 'OK',
                delete: 'Excluir',
                bringToFront: 'Trazer para frente',
                sendToBack: 'Enviar para trás',
                ready: 'Pronto',
                page: 'Página',
                pageOf: 'de'
            },
            'ru': {
                appName: 'PDF Master',
                openFile: 'Открыть файл',
                save: 'Сохранить',
                export: 'Экспорт',
                undo: 'Отменить',
                redo: 'Повторить',
                cut: 'Вырезать',
                copy: 'Копировать',
                paste: 'Вставить',
                addPage: 'Добавить страницу',
                deletePage: 'Удалить страницу',
                reorderPages: 'Порядок страниц',
                settings: 'Настройки',
                pages: 'Страницы',
                uploadPDF: 'Загрузить PDF файл',
                dragDropFile: 'Перетащите файл сюда или нажмите для выбора',
                selectFile: 'Выбрать файл',
                loading: 'Загрузка PDF...',
                properties: 'Свойства',
                fillColor: 'Цвет заливки',
                strokeColor: 'Цвет границы',
                strokeWidth: 'Ширина границы',
                opacity: 'Прозрачность',
                fontSize: 'Размер шрифта',
                fontFamily: 'Шрифт',
                select: 'Выбрать',
                text: 'Текст',
                draw: 'Рисовать',
                shape: 'Фигура',
                image: 'Изображение',
                highlight: 'Маркер',
                stamp: 'Штамп',
                signature: 'Подпись',
                uploadImage: 'Загрузить изображение',
                dragDropImage: 'Перетащите изображение сюда или нажмите для выбора',
                selectStamp: 'Выбрать штамп',
                drawSignature: 'Нарисовать подпись',
                clear: 'Очистить',
                cancel: 'Отмена',
                ok: 'ОК',
                delete: 'Удалить',
                bringToFront: 'На передний план',
                sendToBack: 'На задний план',
                ready: 'Готово',
                page: 'Страница',
                pageOf: 'из'
            },
            'ar': {
                appName: 'PDF Master',
                openFile: 'فتح ملف',
                save: 'حفظ',
                export: 'تصدير',
                undo: 'تراجع',
                redo: 'إعادة',
                cut: 'قص',
                copy: 'نسخ',
                paste: 'لصق',
                addPage: 'إضافة صفحة',
                deletePage: 'حذف صفحة',
                reorderPages: 'ترتيب الصفحات',
                settings: 'الإعدادات',
                pages: 'الصفحات',
                uploadPDF: 'تحميل ملف PDF',
                dragDropFile: 'اسحب وأفلت الملف هنا أو انقر للاختيار',
                selectFile: 'اختر ملف',
                loading: 'جاري تحميل PDF...',
                properties: 'الخصائص',
                fillColor: 'لون التعبئة',
                strokeColor: 'لون الحدود',
                strokeWidth: 'عرض الحدود',
                opacity: 'الشفافية',
                fontSize: 'حجم الخط',
                fontFamily: 'الخط',
                select: 'تحديد',
                text: 'نص',
                draw: 'رسم',
                shape: 'شكل',
                image: 'صورة',
                highlight: 'تمييز',
                stamp: 'ختم',
                signature: 'توقيع',
                uploadImage: 'تحميل صورة',
                dragDropImage: 'اسحب وأفلت الصورة هنا أو انقر للاختيار',
                selectStamp: 'اختر ختم',
                drawSignature: 'رسم التوقيع',
                clear: 'مسح',
                cancel: 'إلغاء',
                ok: 'موافق',
                delete: 'حذف',
                bringToFront: 'إحضار للأمام',
                sendToBack: 'إرسال للخلف',
                ready: 'جاهز',
                page: 'صفحة',
                pageOf: 'من'
            },
            'hi': { // 印地語
                appName: 'PDF Master',
                openFile: 'फ़ाइल खोलें',
                save: 'सहेजें',
                export: 'निर्यात',
                undo: 'पूर्ववत करें',
                redo: 'फिर से करें',
                cut: 'काटें',
                copy: 'कॉपी',
                paste: 'पेस्ट',
                addPage: 'पृष्ठ जोड़ें',
                deletePage: 'पृष्ठ हटाएं',
                reorderPages: 'पृष्ठ क्रम',
                settings: 'सेटिंग्स',
                pages: 'पृष्ठ',
                uploadPDF: 'PDF अपलोड करें',
                dragDropFile: 'फ़ाइल यहाँ खींचें या चुनने के लिए क्लिक करें',
                selectFile: 'फ़ाइल चुनें',
                loading: 'PDF लोड हो रहा है...',
                properties: 'गुण',
                fillColor: 'भरने का रंग',
                strokeColor: 'बॉर्डर रंग',
                strokeWidth: 'बॉर्डर चौड़ाई',
                opacity: 'पारदर्शिता',
                fontSize: 'फ़ॉन्ट आकार',
                fontFamily: 'फ़ॉन्ट',
                select: 'चुनें',
                text: 'टेक्स्ट',
                draw: 'ड्रॉ',
                shape: 'आकार',
                image: 'छवि',
                highlight: 'हाइलाइट',
                stamp: 'स्टैम्प',
                signature: 'हस्ताक्षर',
                ready: 'तैयार',
                page: 'पृष्ठ',
                pageOf: 'का'
            },
            'it': { // 義大利語
                appName: 'PDF Master',
                openFile: 'Apri file',
                save: 'Salva',
                export: 'Esporta',
                undo: 'Annulla',
                redo: 'Ripeti',
                cut: 'Taglia',
                copy: 'Copia',
                paste: 'Incolla',
                addPage: 'Aggiungi pagina',
                deletePage: 'Elimina pagina',
                reorderPages: 'Riordina pagine',
                settings: 'Impostazioni',
                pages: 'Pagine',
                uploadPDF: 'Carica file PDF',
                dragDropFile: 'Trascina il file qui o clicca per selezionare',
                selectFile: 'Seleziona file',
                loading: 'Caricamento PDF...',
                properties: 'Proprietà',
                fillColor: 'Colore di riempimento',
                strokeColor: 'Colore bordo',
                strokeWidth: 'Larghezza bordo',
                opacity: 'Opacità',
                fontSize: 'Dimensione carattere',
                fontFamily: 'Carattere',
                select: 'Seleziona',
                text: 'Testo',
                draw: 'Disegna',
                shape: 'Forma',
                image: 'Immagine',
                highlight: 'Evidenzia',
                stamp: 'Timbro',
                signature: 'Firma',
                ready: 'Pronto',
                page: 'Pagina',
                pageOf: 'di'
            },
            'nl': { // 荷蘭語
                appName: 'PDF Master',
                openFile: 'Bestand openen',
                save: 'Opslaan',
                export: 'Exporteren',
                undo: 'Ongedaan maken',
                redo: 'Opnieuw',
                cut: 'Knippen',
                copy: 'Kopiëren',
                paste: 'Plakken',
                addPage: 'Pagina toevoegen',
                deletePage: 'Pagina verwijderen',
                reorderPages: 'Pagina volgorde',
                settings: 'Instellingen',
                pages: 'Pagina\'s',
                uploadPDF: 'PDF uploaden',
                dragDropFile: 'Sleep bestand hier of klik om te selecteren',
                selectFile: 'Bestand selecteren',
                loading: 'PDF laden...',
                properties: 'Eigenschappen',
                fillColor: 'Vulkleur',
                strokeColor: 'Randkleur',
                strokeWidth: 'Randbreedte',
                opacity: 'Transparantie',
                fontSize: 'Lettergrootte',
                fontFamily: 'Lettertype',
                select: 'Selecteren',
                text: 'Tekst',
                draw: 'Tekenen',
                shape: 'Vorm',
                image: 'Afbeelding',
                highlight: 'Markeren',
                stamp: 'Stempel',
                signature: 'Handtekening',
                ready: 'Gereed',
                page: 'Pagina',
                pageOf: 'van'
            },
            'pl': { // 波蘭語
                appName: 'PDF Master',
                openFile: 'Otwórz plik',
                save: 'Zapisz',
                export: 'Eksportuj',
                undo: 'Cofnij',
                redo: 'Ponów',
                cut: 'Wytnij',
                copy: 'Kopiuj',
                paste: 'Wklej',
                addPage: 'Dodaj stronę',
                deletePage: 'Usuń stronę',
                reorderPages: 'Kolejność stron',
                settings: 'Ustawienia',
                pages: 'Strony',
                uploadPDF: 'Prześlij plik PDF',
                dragDropFile: 'Przeciągnij plik tutaj lub kliknij aby wybrać',
                selectFile: 'Wybierz plik',
                loading: 'Ładowanie PDF...',
                properties: 'Właściwości',
                fillColor: 'Kolor wypełnienia',
                strokeColor: 'Kolor obramowania',
                strokeWidth: 'Szerokość obramowania',
                opacity: 'Przezroczystość',
                fontSize: 'Rozmiar czcionki',
                fontFamily: 'Czcionka',
                select: 'Wybierz',
                text: 'Tekst',
                draw: 'Rysuj',
                shape: 'Kształt',
                image: 'Obraz',
                highlight: 'Zaznacz',
                stamp: 'Pieczątka',
                signature: 'Podpis',
                ready: 'Gotowe',
                page: 'Strona',
                pageOf: 'z'
            },
            'tr': { // 土耳其語
                appName: 'PDF Master',
                openFile: 'Dosya Aç',
                save: 'Kaydet',
                export: 'Dışa Aktar',
                undo: 'Geri Al',
                redo: 'Yinele',
                cut: 'Kes',
                copy: 'Kopyala',
                paste: 'Yapıştır',
                addPage: 'Sayfa Ekle',
                deletePage: 'Sayfa Sil',
                reorderPages: 'Sayfa Sırası',
                settings: 'Ayarlar',
                pages: 'Sayfalar',
                uploadPDF: 'PDF Yükle',
                dragDropFile: 'Dosyayı buraya sürükleyin veya seçmek için tıklayın',
                selectFile: 'Dosya Seç',
                loading: 'PDF yükleniyor...',
                properties: 'Özellikler',
                fillColor: 'Dolgu Rengi',
                strokeColor: 'Kenarlık Rengi',
                strokeWidth: 'Kenarlık Genişliği',
                opacity: 'Şeffaflık',
                fontSize: 'Yazı Boyutu',
                fontFamily: 'Yazı Tipi',
                select: 'Seç',
                text: 'Metin',
                draw: 'Çiz',
                shape: 'Şekil',
                image: 'Resim',
                highlight: 'Vurgula',
                stamp: 'Damga',
                signature: 'İmza',
                ready: 'Hazır',
                page: 'Sayfa',
                pageOf: '/'
            },
            'vi': { // 越南語
                appName: 'PDF Master',
                openFile: 'Mở tệp',
                save: 'Lưu',
                export: 'Xuất',
                undo: 'Hoàn tác',
                redo: 'Làm lại',
                cut: 'Cắt',
                copy: 'Sao chép',
                paste: 'Dán',
                addPage: 'Thêm trang',
                deletePage: 'Xóa trang',
                reorderPages: 'Sắp xếp trang',
                settings: 'Cài đặt',
                pages: 'Trang',
                uploadPDF: 'Tải lên PDF',
                dragDropFile: 'Kéo thả tệp vào đây hoặc nhấp để chọn',
                selectFile: 'Chọn tệp',
                loading: 'Đang tải PDF...',
                properties: 'Thuộc tính',
                fillColor: 'Màu tô',
                strokeColor: 'Màu viền',
                strokeWidth: 'Độ rộng viền',
                opacity: 'Độ trong suốt',
                fontSize: 'Cỡ chữ',
                fontFamily: 'Phông chữ',
                select: 'Chọn',
                text: 'Văn bản',
                draw: 'Vẽ',
                shape: 'Hình dạng',
                image: 'Hình ảnh',
                highlight: 'Đánh dấu',
                stamp: 'Con dấu',
                signature: 'Chữ ký',
                ready: 'Sẵn sàng',
                page: 'Trang',
                pageOf: 'của'
            },
            'th': { // 泰語
                appName: 'PDF Master',
                openFile: 'เปิดไฟล์',
                save: 'บันทึก',
                export: 'ส่งออก',
                undo: 'เลิกทำ',
                redo: 'ทำซ้ำ',
                cut: 'ตัด',
                copy: 'คัดลอก',
                paste: 'วาง',
                addPage: 'เพิ่มหน้า',
                deletePage: 'ลบหน้า',
                reorderPages: 'จัดเรียงหน้า',
                settings: 'การตั้งค่า',
                pages: 'หน้า',
                uploadPDF: 'อัปโหลด PDF',
                dragDropFile: 'ลากไฟล์มาที่นี่หรือคลิกเพื่อเลือก',
                selectFile: 'เลือกไฟล์',
                loading: 'กำลังโหลด PDF...',
                properties: 'คุณสมบัติ',
                fillColor: 'สีเติม',
                strokeColor: 'สีขอบ',
                strokeWidth: 'ความกว้างขอบ',
                opacity: 'ความโปร่งใส',
                fontSize: 'ขนาดตัวอักษร',
                fontFamily: 'แบบอักษร',
                select: 'เลือก',
                text: 'ข้อความ',
                draw: 'วาด',
                shape: 'รูปร่าง',
                image: 'รูปภาพ',
                highlight: 'ไฮไลต์',
                stamp: 'ตราประทับ',
                signature: 'ลายเซ็น',
                ready: 'พร้อม',
                page: 'หน้า',
                pageOf: 'จาก'
            },
            'id': { // 印尼語
                appName: 'PDF Master',
                openFile: 'Buka File',
                save: 'Simpan',
                export: 'Ekspor',
                undo: 'Batalkan',
                redo: 'Ulangi',
                cut: 'Potong',
                copy: 'Salin',
                paste: 'Tempel',
                addPage: 'Tambah Halaman',
                deletePage: 'Hapus Halaman',
                reorderPages: 'Urutan Halaman',
                settings: 'Pengaturan',
                pages: 'Halaman',
                uploadPDF: 'Unggah PDF',
                dragDropFile: 'Seret file ke sini atau klik untuk memilih',
                selectFile: 'Pilih File',
                loading: 'Memuat PDF...',
                properties: 'Properti',
                fillColor: 'Warna Isi',
                strokeColor: 'Warna Batas',
                strokeWidth: 'Lebar Batas',
                opacity: 'Transparansi',
                fontSize: 'Ukuran Font',
                fontFamily: 'Jenis Font',
                select: 'Pilih',
                text: 'Teks',
                draw: 'Gambar',
                shape: 'Bentuk',
                image: 'Gambar',
                highlight: 'Sorot',
                stamp: 'Stempel',
                signature: 'Tanda Tangan',
                ready: 'Siap',
                page: 'Halaman',
                pageOf: 'dari'
            },
            'sv': { // 瑞典語
                appName: 'PDF Master',
                openFile: 'Öppna fil',
                save: 'Spara',
                export: 'Exportera',
                undo: 'Ångra',
                redo: 'Gör om',
                cut: 'Klipp ut',
                copy: 'Kopiera',
                paste: 'Klistra in',
                addPage: 'Lägg till sida',
                deletePage: 'Ta bort sida',
                reorderPages: 'Sidordning',
                settings: 'Inställningar',
                pages: 'Sidor',
                uploadPDF: 'Ladda upp PDF',
                dragDropFile: 'Dra filen hit eller klicka för att välja',
                selectFile: 'Välj fil',
                loading: 'Laddar PDF...',
                properties: 'Egenskaper',
                fillColor: 'Fyllnadsfärg',
                strokeColor: 'Kantfärg',
                strokeWidth: 'Kantbredd',
                opacity: 'Genomskinlighet',
                fontSize: 'Teckenstorlek',
                fontFamily: 'Teckensnitt',
                select: 'Välj',
                text: 'Text',
                draw: 'Rita',
                shape: 'Form',
                image: 'Bild',
                highlight: 'Markera',
                stamp: 'Stämpel',
                signature: 'Signatur',
                ready: 'Redo',
                page: 'Sida',
                pageOf: 'av'
            }
        };
        
        // 應用程式狀態管理
        const AppState = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 0,
            scale: 1.0,
            canvas: null,
            fabricCanvas: null,
            currentTool: 'select',
            isDrawing: false,
            history: [],
            historyIndex: -1,
            clipboard: null,
            selectedObject: null,
            pages: {},
            modifications: {},
            currentLanguage: 'zh-TW',
            signatureCanvas: null,
            isSignatureDrawing: false,
            newsItems: [],
            currentNewsIndex: 0,
            adItems: [],
            botConfig: {
                apiEndpoint: 'https://api.pdfmaster.com/v1',
                apiKey: '',
                autoReplyEnabled: false
            }
        };
        
        // 初始化應用程式
        function initializeApp() {
            // 檢查並設置語言
            const savedLang = localStorage.getItem('pdfMasterLanguage') || 'zh-TW';
            AppState.currentLanguage = savedLang;
            updateLanguage();
            
            // 設置拖放事件
            setupDragAndDrop();
            
            // 初始化 Fabric.js
            initializeFabricCanvas();
            
            // 設置鍵盤快捷鍵
            setupKeyboardShortcuts();
            
            // 設置右鍵選單
            setupContextMenu();
            
            // 初始化簽名板
            initializeSignaturePad();
            
            // 顯示狀態訊息
            updateStatus(t('ready'));
        }
        
        // 翻譯函數
        function t(key) {
            return translations[AppState.currentLanguage][key] || key;
        }
        
        // 更新語言
        function updateLanguage() {
            document.documentElement.lang = AppState.currentLanguage;
            
            // 更新所有帶有 data-i18n 屬性的元素
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // 更新所有帶有 data-tooltip 屬性的元素
            document.querySelectorAll('[data-tooltip]').forEach(element => {
                const key = element.getAttribute('data-tooltip');
                element.setAttribute('data-tooltip', t(key));
            });
            
            // 更新當前語言顯示
            const langNames = {
                'zh-TW': '繁體中文',
                'en': 'English',
                'zh-CN': '简体中文',
                'ja': '日本語',
                'ko': '한국어',
                'es': 'Español',
                'fr': 'Français',
                'de': 'Deutsch',
                'pt': 'Português',
                'ru': 'Русский',
                'ar': 'العربية',
                'hi': 'हिन्दी',
                'it': 'Italiano',
                'nl': 'Nederlands',
                'pl': 'Polski',
                'tr': 'Türkçe',
                'vi': 'Tiếng Việt',
                'th': 'ไทย',
                'id': 'Bahasa Indonesia',
                'sv': 'Svenska'
            };
            document.getElementById('current-lang').textContent = langNames[AppState.currentLanguage];
            
            // 如果是阿拉伯語，設置RTL
            if (AppState.currentLanguage === 'ar') {
                document.body.style.direction = 'rtl';
            } else {
                document.body.style.direction = 'ltr';
            }
        }
        
        // 切換語言選單
        function toggleLanguageMenu() {
            const menu = document.getElementById('language-menu');
            menu.classList.toggle('active');
        }
        
        // 切換語言
        function changeLanguage(lang) {
            AppState.currentLanguage = lang;
            localStorage.setItem('pdfMasterLanguage', lang);
            updateLanguage();
            toggleLanguageMenu();
            updateStatus(t('ready'));
        }
        
        // 設置拖放功能
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            const canvasWrapper = document.getElementById('canvas-wrapper');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                canvasWrapper.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                canvasWrapper.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                canvasWrapper.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadArea.style.background = '#f0f8ff';
                uploadArea.style.borderColor = '#1a73e8';
            }
            
            function unhighlight(e) {
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '';
            }
            
            canvasWrapper.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0]);
                }
            }
        }
        
        // 處理檔案選擇
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                handleFile(file);
            }
        }
        
        // 處理PDF檔案
        async function handleFile(file) {
            const uploadArea = document.getElementById('upload-area');
            const loading = document.getElementById('loading');
            const canvasContainer = document.getElementById('pdf-canvas-container');
            
            uploadArea.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                
                AppState.pdfDoc = await loadingTask.promise;
                AppState.totalPages = AppState.pdfDoc.numPages;
                AppState.currentPage = 1;
                
                // 初始化頁面資料結構
                for (let i = 1; i <= AppState.totalPages; i++) {
                    AppState.pages[i] = { objects: [] };
                    AppState.modifications[i] = [];
                }
                
                // 載入頁面縮圖
                await loadThumbnails();
                
                // 渲染第一頁
                await renderPage(1);
                
                loading.style.display = 'none';
                canvasContainer.style.display = 'block';
                
                updateStatus(`已載入 ${file.name} (共 ${AppState.totalPages} 頁)`);
            } catch (error) {
                console.error('載入PDF時發生錯誤:', error);
                loading.style.display = 'none';
                uploadArea.style.display = 'block';
                alert('載入PDF時發生錯誤，請確認檔案格式正確。');
            }
        }
        
        // 載入頁面縮圖
        async function loadThumbnails() {
            const pageList = document.getElementById('page-list');
            pageList.innerHTML = '';
            
            for (let i = 1; i <= AppState.totalPages; i++) {
                const page = await AppState.pdfDoc.getPage(i);
                const scale = 0.3;
                const viewport = page.getViewport({ scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                pageItem.onclick = () => goToPage(i);
                if (i === 1) pageItem.classList.add('active');
                
                const img = document.createElement('img');
                img.className = 'page-thumbnail';
                img.src = canvas.toDataURL();
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = `第 ${i} 頁`;
                
                pageItem.appendChild(img);
                pageItem.appendChild(pageNumber);
                pageList.appendChild(pageItem);
            }
        }
        
        // 渲染PDF頁面
        async function renderPage(pageNum) {
            if (!AppState.pdfDoc) return;
            
            // 儲存當前頁面的編輯內容
            if (AppState.fabricCanvas) {
                saveCurrentPageState();
            }
            
            const page = await AppState.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: AppState.scale });
            
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            // 更新 Fabric canvas 尺寸
            if (AppState.fabricCanvas) {
                AppState.fabricCanvas.setWidth(viewport.width);
                AppState.fabricCanvas.setHeight(viewport.height);
                
                // 載入該頁面的編輯內容
                loadPageState(pageNum);
            }
            
            // 更新頁面資訊
            document.getElementById('page-info').textContent = `${pageNum} / ${AppState.totalPages}`;
            
            // 更新縮圖選中狀態
            updateThumbnailSelection(pageNum);
            
            AppState.currentPage = pageNum;
        }
        
        // 初始化 Fabric.js Canvas
        function initializeFabricCanvas() {
            const fabricCanvas = new fabric.Canvas('fabric-canvas', {
                selection: true,
                preserveObjectStacking: true
            });
            
            AppState.fabricCanvas = fabricCanvas;
            
            // 物件選中事件
            fabricCanvas.on('selection:created', (e) => {
                AppState.selectedObject = e.selected[0];
                showPropertiesPanel();
                updatePropertyValues();
            });
            
            fabricCanvas.on('selection:updated', (e) => {
                AppState.selectedObject = e.selected[0];
                updatePropertyValues();
            });
            
            fabricCanvas.on('selection:cleared', () => {
                AppState.selectedObject = null;
                hidePropertiesPanel();
            });
            
            // 物件修改事件
            fabricCanvas.on('object:modified', () => {
                saveToHistory();
            });
            
            // 滑鼠事件處理
            fabricCanvas.on('mouse:down', handleMouseDown);
            fabricCanvas.on('mouse:move', handleMouseMove);
            fabricCanvas.on('mouse:up', handleMouseUp);
        }
        
        // 工具切換
        function setTool(tool) {
            AppState.currentTool = tool;
            
            // 更新工具按鈕狀態
            document.querySelectorAll('.floating-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // 設置游標樣式
            switch (tool) {
                case 'select':
                    AppState.fabricCanvas.defaultCursor = 'default';
                    AppState.fabricCanvas.isDrawingMode = false;
                    break;
                case 'text':
                    AppState.fabricCanvas.defaultCursor = 'text';
                    AppState.fabricCanvas.isDrawingMode = false;
                    break;
                case 'draw':
                    AppState.fabricCanvas.defaultCursor = 'crosshair';
                    AppState.fabricCanvas.isDrawingMode = true;
                    AppState.fabricCanvas.freeDrawingBrush.width = 2;
                    AppState.fabricCanvas.freeDrawingBrush.color = '#000000';
                    break;
                case 'shape':
                    AppState.fabricCanvas.defaultCursor = 'crosshair';
                    AppState.fabricCanvas.isDrawingMode = false;
                    break;
                case 'highlight':
                    AppState.fabricCanvas.defaultCursor = 'crosshair';
                    AppState.fabricCanvas.isDrawingMode = true;
                    AppState.fabricCanvas.freeDrawingBrush.width = 20;
                    AppState.fabricCanvas.freeDrawingBrush.color = 'rgba(255, 255, 0, 0.5)';
                    break;
                case 'image':
                    AppState.fabricCanvas.defaultCursor = 'default';
                    AppState.fabricCanvas.isDrawingMode = false;
                    showModal('image-modal');
                    break;
                case 'stamp':
                    AppState.fabricCanvas.defaultCursor = 'default';
                    AppState.fabricCanvas.isDrawingMode = false;
                    showModal('stamp-modal');
                    break;
                case 'signature':
                    AppState.fabricCanvas.defaultCursor = 'default';
                    AppState.fabricCanvas.isDrawingMode = false;
                    showModal('signature-modal');
                    break;
            }
            
            updateStatus(`${t('ready')} - ${t(tool)}`);
        }
        
        // 滑鼠事件處理
        function handleMouseDown(options) {
            if (AppState.currentTool === 'text' && !options.target) {
                const pointer = AppState.fabricCanvas.getPointer(options.e);
                showTextEditor(pointer.x, pointer.y);
            } else if (AppState.currentTool === 'shape' && !options.target) {
                const pointer = AppState.fabricCanvas.getPointer(options.e);
                startDrawingShape(pointer.x, pointer.y);
            }
        }
        
        function handleMouseMove(options) {
            if (AppState.isDrawing && AppState.currentTool === 'shape') {
                const pointer = AppState.fabricCanvas.getPointer(options.e);
                updateDrawingShape(pointer.x, pointer.y);
            }
        }
        
        function handleMouseUp(options) {
            if (AppState.isDrawing && AppState.currentTool === 'shape') {
                AppState.isDrawing = false;
                saveToHistory();
            }
        }
        
        // 文字編輯器
        function showTextEditor(x, y) {
            const editor = document.getElementById('text-editor');
            const input = document.getElementById('text-editor-input');
            
            editor.style.left = x + 'px';
            editor.style.top = y + 'px';
            editor.style.display = 'block';
            
            input.value = '';
            input.focus();
            
            input.onblur = () => {
                if (input.value.trim()) {
                    const text = new fabric.IText(input.value, {
                        left: x,
                        top: y,
                        fontFamily: 'Arial',
                        fontSize: 16,
                        fill: '#000000'
                    });
                    AppState.fabricCanvas.add(text);
                    saveToHistory();
                }
                editor.style.display = 'none';
            };
            
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    input.blur();
                }
            };
        }
        
        // 形狀繪製
        let drawingShape = null;
        let shapeStartX = 0;
        let shapeStartY = 0;
        
        function startDrawingShape(x, y) {
            AppState.isDrawing = true;
            shapeStartX = x;
            shapeStartY = y;
            
            // 預設繪製矩形
            drawingShape = new fabric.Rect({
                left: x,
                top: y,
                width: 0,
                height: 0,
                fill: 'transparent',
                stroke: '#000000',
                strokeWidth: 2
            });
            
            AppState.fabricCanvas.add(drawingShape);
        }
        
        function updateDrawingShape(x, y) {
            if (!drawingShape) return;
            
            const width = Math.abs(x - shapeStartX);
            const height = Math.abs(y - shapeStartY);
            const left = Math.min(x, shapeStartX);
            const top = Math.min(y, shapeStartY);
            
            drawingShape.set({
                left: left,
                top: top,
                width: width,
                height: height
            });
            
            AppState.fabricCanvas.renderAll();
        }
        
        // 頁面導航
        function previousPage() {
            if (AppState.currentPage > 1) {
                goToPage(AppState.currentPage - 1);
            }
        }
        
        function nextPage() {
            if (AppState.currentPage < AppState.totalPages) {
                goToPage(AppState.currentPage + 1);
            }
        }
        
        function goToPage(pageNum) {
            if (pageNum >= 1 && pageNum <= AppState.totalPages) {
                renderPage(pageNum);
            }
        }
        
        // 縮放控制
        function zoomIn() {
            AppState.scale = Math.min(AppState.scale * 1.2, 3.0);
            renderPage(AppState.currentPage);
            updateZoomLevel();
        }
        
        function zoomOut() {
            AppState.scale = Math.max(AppState.scale / 1.2, 0.3);
            renderPage(AppState.currentPage);
            updateZoomLevel();
        }
        
        function fitToPage() {
            const wrapper = document.getElementById('canvas-wrapper');
            const wrapperWidth = wrapper.clientWidth - 40;
            const wrapperHeight = wrapper.clientHeight - 40;
            
            if (AppState.pdfDoc) {
                AppState.pdfDoc.getPage(AppState.currentPage).then(page => {
                    const viewport = page.getViewport({ scale: 1 });
                    const scaleX = wrapperWidth / viewport.width;
                    const scaleY = wrapperHeight / viewport.height;
                    AppState.scale = Math.min(scaleX, scaleY);
                    renderPage(AppState.currentPage);
                    updateZoomLevel();
                });
            }
        }
        
        function updateZoomLevel() {
            document.getElementById('zoom-level').textContent = Math.round(AppState.scale * 100) + '%';
        }
        
        // 屬性面板
        function showPropertiesPanel() {
            document.getElementById('properties-panel').classList.add('active');
        }
        
        function hidePropertiesPanel() {
            document.getElementById('properties-panel').classList.remove('active');
        }
        
        function updatePropertyValues() {
            if (!AppState.selectedObject) return;
            
            const obj = AppState.selectedObject;
            
            // 更新屬性值
            if (obj.fill) {
                document.getElementById('fill-color').value = obj.fill;
            }
            if (obj.stroke) {
                document.getElementById('stroke-color').value = obj.stroke;
            }
            if (obj.strokeWidth) {
                document.getElementById('stroke-width').value = obj.strokeWidth;
            }
            if (obj.opacity !== undefined) {
                document.getElementById('opacity').value = obj.opacity * 100;
            }
            if (obj.fontSize) {
                document.getElementById('font-size').value = obj.fontSize;
            }
            if (obj.fontFamily) {
                document.getElementById('font-family').value = obj.fontFamily;
            }
        }
        
        function updateObjectProperty(property) {
            if (!AppState.selectedObject) return;
            
            const value = document.getElementById(property.toLowerCase().replace(/([A-Z])/g, '-$1')).value;
            
            switch (property) {
                case 'fill':
                case 'stroke':
                    AppState.selectedObject.set(property, value);
                    break;
                case 'strokeWidth':
                case 'fontSize':
                    AppState.selectedObject.set(property, parseInt(value));
                    break;
                case 'opacity':
                    AppState.selectedObject.set('opacity', value / 100);
                    break;
                case 'fontFamily':
                    AppState.selectedObject.set('fontFamily', value);
                    break;
            }
            
            AppState.fabricCanvas.renderAll();
            saveToHistory();
        }
        
        // 歷史記錄管理
        function saveToHistory() {
            const state = JSON.stringify(AppState.fabricCanvas.toJSON());
            AppState.history = AppState.history.slice(0, AppState.historyIndex + 1);
            AppState.history.push(state);
            AppState.historyIndex++;
            
            // 限制歷史記錄數量
            if (AppState.history.length > 50) {
                AppState.history.shift();
                AppState.historyIndex--;
            }
        }
        
        function undo() {
            if (AppState.historyIndex > 0) {
                AppState.historyIndex--;
                const state = JSON.parse(AppState.history[AppState.historyIndex]);
                AppState.fabricCanvas.loadFromJSON(state, () => {
                    AppState.fabricCanvas.renderAll();
                });
                updateStatus('已復原');
            }
        }
        
        function redo() {
            if (AppState.historyIndex < AppState.history.length - 1) {
                AppState.historyIndex++;
                const state = JSON.parse(AppState.history[AppState.historyIndex]);
                AppState.fabricCanvas.loadFromJSON(state, () => {
                    AppState.fabricCanvas.renderAll();
                });
                updateStatus('已重做');
            }
        }
        
        // 剪貼簿操作
        function cut() {
            copy();
            deleteSelected();
        }
        
        function copy() {
            if (AppState.selectedObject) {
                AppState.clipboard = AppState.selectedObject.toObject();
                updateStatus('已複製到剪貼簿');
            }
        }
        
        function paste() {
            if (AppState.clipboard) {
                fabric.util.enlivenObjects([AppState.clipboard], (objects) => {
                    objects.forEach((obj) => {
                        obj.set({
                            left: obj.left + 10,
                            top: obj.top + 10
                        });
                        AppState.fabricCanvas.add(obj);
                    });
                    AppState.fabricCanvas.renderAll();
                    saveToHistory();
                    updateStatus('已貼上');
                });
            }
        }
        
        function deleteSelected() {
            const activeObjects = AppState.fabricCanvas.getActiveObjects();
            activeObjects.forEach(obj => {
                AppState.fabricCanvas.remove(obj);
            });
            AppState.fabricCanvas.discardActiveObject();
            AppState.fabricCanvas.renderAll();
            saveToHistory();
            updateStatus('已刪除選中物件');
        }
        
        // 頁面狀態管理
        function saveCurrentPageState() {
            if (AppState.currentPage && AppState.fabricCanvas) {
                AppState.pages[AppState.currentPage].objects = AppState.fabricCanvas.toJSON().objects;
            }
        }
        
        function loadPageState(pageNum) {
            AppState.fabricCanvas.clear();
            
            if (AppState.pages[pageNum] && AppState.pages[pageNum].objects.length > 0) {
                fabric.util.enlivenObjects(AppState.pages[pageNum].objects, (objects) => {
                    objects.forEach(obj => {
                        AppState.fabricCanvas.add(obj);
                    });
                    AppState.fabricCanvas.renderAll();
                });
            }
        }
        
        // 匯出PDF - 完整實現
        async function exportPDF() {
            if (!AppState.pdfDoc) {
                alert('請先載入 PDF 檔案');
                return;
            }
            
            updateStatus('正在準備匯出PDF...');
            
            try {
                // 儲存當前頁面狀態
                saveCurrentPageState();
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                let firstPage = true;
                
                for (let i = 1; i <= AppState.totalPages; i++) {
                    // 渲染原始PDF頁面
                    const page = await AppState.pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 2 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // 考慮頁面旋轉
                    const rotation = AppState.pageRotations && AppState.pageRotations[i] || 0;
                    if (rotation !== 0) {
                        context.save();
                        context.translate(canvas.width / 2, canvas.height / 2);
                        context.rotate(rotation * Math.PI / 180);
                        context.translate(-canvas.width / 2, -canvas.height / 2);
                    }
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    if (rotation !== 0) {
                        context.restore();
                    }
                    
                    // 如果有編輯內容，創建臨時 canvas 來合併
                    if (AppState.pages[i] && AppState.pages[i].objects && AppState.pages[i].objects.length > 0) {
                        const tempCanvas = new fabric.Canvas(null, {
                            width: viewport.width,
                            height: viewport.height
                        });
                        
                        // 載入該頁的編輯內容
                        await new Promise((resolve) => {
                            fabric.util.enlivenObjects(AppState.pages[i].objects, (objects) => {
                                objects.forEach(obj => {
                                    // 調整物件比例
                                    obj.scaleX = (obj.scaleX || 1) * (viewport.width / AppState.fabricCanvas.width);
                                    obj.scaleY = (obj.scaleY || 1) * (viewport.height / AppState.fabricCanvas.height);
                                    obj.left = obj.left * (viewport.width / AppState.fabricCanvas.width);
                                    obj.top = obj.top * (viewport.height / AppState.fabricCanvas.height);
                                    tempCanvas.add(obj);
                                });
                                tempCanvas.renderAll();
                                resolve();
                            });
                        });
                        
                        // 將編輯內容繪製到主 canvas 上
                        context.drawImage(tempCanvas.getElement(), 0, 0);
                    }
                    
                    // 添加到 PDF
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    
                    if (firstPage) {
                        firstPage = false;
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const scale = Math.min(pdfWidth / viewport.width, pdfHeight / viewport.height);
                        const scaledWidth = viewport.width * scale;
                        const scaledHeight = viewport.height * scale;
                        const x = (pdfWidth - scaledWidth) / 2;
                        const y = (pdfHeight - scaledHeight) / 2;
                        pdf.addImage(imgData, 'JPEG', x, y, scaledWidth, scaledHeight);
                    } else {
                        pdf.addPage();
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const scale = Math.min(pdfWidth / viewport.width, pdfHeight / viewport.height);
                        const scaledWidth = viewport.width * scale;
                        const scaledHeight = viewport.height * scale;
                        const x = (pdfWidth - scaledWidth) / 2;
                        const y = (pdfHeight - scaledHeight) / 2;
                        pdf.addImage(imgData, 'JPEG', x, y, scaledWidth, scaledHeight);
                    }
                    
                    updateStatus(`正在處理第 ${i}/${AppState.totalPages} 頁...`);
                }
                
                // 儲存 PDF
                const fileName = AppState.fileName ? AppState.fileName.replace('.pdf', '_edited.pdf') : 'edited_document.pdf';
                pdf.save(fileName);
                updateStatus('PDF 匯出完成');
                
            } catch (error) {
                console.error('匯出 PDF 時發生錯誤:', error);
                alert('匯出 PDF 時發生錯誤: ' + error.message);
                updateStatus('匯出失敗');
            }
        }
        
        // 分割 PDF 功能
        function splitPDF() {
            if (!AppState.pdfDoc) {
                alert('請先載入 PDF 檔案');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <span>分割 PDF</span>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <p>選擇分割方式：</p>
                        <div style="margin: 10px 0;">
                            <label>
                                <input type="radio" name="split-type" value="single" checked>
                                每頁分割為單獨檔案
                            </label>
                        </div>
                        <div style="margin: 10px 0;">
                            <label>
                                <input type="radio" name="split-type" value="range">
                                按頁面範圍分割
                            </label>
                            <div id="range-options" style="display: none; margin-top: 10px;">
                                <input type="text" id="page-ranges" placeholder="例如: 1-3,5,7-9" style="width: 200px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="performSplit()">分割</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 切換選項顯示
            modal.querySelectorAll('input[name="split-type"]').forEach(radio => {
                radio.onchange = () => {
                    document.getElementById('range-options').style.display = 
                        radio.value === 'range' ? 'block' : 'none';
                };
            });
        }
        
        async function performSplit() {
            const splitType = document.querySelector('input[name="split-type"]:checked').value;
            updateStatus('正在分割 PDF...');
            
            try {
                const { jsPDF } = window.jspdf;
                
                if (splitType === 'single') {
                    // 每頁分割
                    for (let i = 1; i <= AppState.totalPages; i++) {
                        const pdf = new jsPDF();
                        const page = await AppState.pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 2 });
                        
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        
                        pdf.save(`page_${i}.pdf`);
                    }
                } else {
                    // 按範圍分割
                    const ranges = parsePageRanges(document.getElementById('page-ranges').value);
                    
                    for (let rangeIndex = 0; rangeIndex < ranges.length; rangeIndex++) {
                        const range = ranges[rangeIndex];
                        const pdf = new jsPDF();
                        let firstPage = true;
                        
                        for (const pageNum of range) {
                            if (pageNum > 0 && pageNum <= AppState.totalPages) {
                                if (!firstPage) {
                                    pdf.addPage();
                                }
                                firstPage = false;
                                
                                const page = await AppState.pdfDoc.getPage(pageNum);
                                const viewport = page.getViewport({ scale: 2 });
                                
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.width = viewport.width;
                                canvas.height = viewport.height;
                                
                                await page.render({
                                    canvasContext: context,
                                    viewport: viewport
                                }).promise;
                                
                                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                                const pdfWidth = pdf.internal.pageSize.getWidth();
                                const pdfHeight = pdf.internal.pageSize.getHeight();
                                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                            }
                        }
                        
                        pdf.save(`split_${rangeIndex + 1}.pdf`);
                    }
                }
                
                document.querySelector('.modal.active').remove();
                updateStatus('PDF 分割完成');
                
            } catch (error) {
                console.error('分割 PDF 時發生錯誤:', error);
                alert('分割 PDF 時發生錯誤');
                updateStatus('分割失敗');
            }
        }
        
        function parsePageRanges(input) {
            const ranges = [];
            const parts = input.split(',');
            
            for (const part of parts) {
                const trimmed = part.trim();
                if (trimmed.includes('-')) {
                    const [start, end] = trimmed.split('-').map(n => parseInt(n));
                    const range = [];
                    for (let i = start; i <= end; i++) {
                        range.push(i);
                    }
                    ranges.push(range);
                } else {
                    ranges.push([parseInt(trimmed)]);
                }
            }
            
            return ranges;
        }
        
        // 添加水印功能
        function addWatermark() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <span>添加水印</span>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 10px;">
                            <label>水印文字：</label>
                            <input type="text" id="watermark-text" value="機密文件" style="width: 200px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>字體大小：</label>
                            <input type="number" id="watermark-size" value="48" min="12" max="200" style="width: 80px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>透明度：</label>
                            <input type="range" id="watermark-opacity" min="0" max="100" value="20" style="width: 200px;">
                            <span id="opacity-value">20%</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>顏色：</label>
                            <input type="color" id="watermark-color" value="#cccccc">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>角度：</label>
                            <input type="range" id="watermark-angle" min="-90" max="90" value="-45" style="width: 200px;">
                            <span id="angle-value">-45°</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="applyWatermark()">應用到所有頁面</button>
                        <button class="btn btn-primary" onclick="applyWatermark(true)">僅應用到當前頁</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 更新顯示值
            document.getElementById('watermark-opacity').oninput = function() {
                document.getElementById('opacity-value').textContent = this.value + '%';
            };
            document.getElementById('watermark-angle').oninput = function() {
                document.getElementById('angle-value').textContent = this.value + '°';
            };
        }
        
        function applyWatermark(currentPageOnly = false) {
            const text = document.getElementById('watermark-text').value;
            const size = parseInt(document.getElementById('watermark-size').value);
            const opacity = parseInt(document.getElementById('watermark-opacity').value) / 100;
            const color = document.getElementById('watermark-color').value;
            const angle = parseInt(document.getElementById('watermark-angle').value);
            
            if (!text) {
                alert('請輸入水印文字');
                return;
            }
            
            const watermark = new fabric.Text(text, {
                fontSize: size,
                fill: color,
                opacity: opacity,
                angle: angle,
                originX: 'center',
                originY: 'center',
                left: AppState.fabricCanvas.width / 2,
                top: AppState.fabricCanvas.height / 2,
                selectable: false,
                evented: false
            });
            
            if (currentPageOnly) {
                AppState.fabricCanvas.add(watermark);
                watermark.sendToBack();
                saveToHistory();
                updateStatus('已添加水印到當前頁');
            } else {
                // 添加到所有頁面
                for (let i = 1; i <= AppState.totalPages; i++) {
                    if (!AppState.pages[i]) {
                        AppState.pages[i] = { objects: [] };
                    }
                    AppState.pages[i].watermark = watermark.toObject();
                }
                
                // 如果是當前頁，立即顯示
                if (AppState.currentPage) {
                    AppState.fabricCanvas.add(watermark);
                    watermark.sendToBack();
                }
                
                updateStatus('已添加水印到所有頁面');
            }
            
            document.querySelector('.modal.active').remove();
        }
        
        // 旋轉頁面功能
        function rotatePage(degrees) {
            if (!AppState.currentPage) return;
            
            // 初始化旋轉記錄
            if (!AppState.pageRotations) {
                AppState.pageRotations = {};
            }
            
            // 更新旋轉角度
            const currentRotation = AppState.pageRotations[AppState.currentPage] || 0;
            AppState.pageRotations[AppState.currentPage] = (currentRotation + degrees) % 360;
            
            // 重新渲染頁面
            renderPage(AppState.currentPage);
            updateStatus(`頁面已旋轉 ${degrees} 度`);
        }
        
        // 設定功能
        function showSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <span>設定</span>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="setting-group">
                            <h3>顯示設定</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="show-grid" ${AppState.showGrid ? 'checked' : ''}>
                                    顯示網格
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="show-rulers" ${AppState.showRulers ? 'checked' : ''}>
                                    顯示尺規
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="auto-save" ${AppState.autoSave ? 'checked' : ''}>
                                    自動儲存編輯
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <h3>預設值</h3>
                            <div class="setting-item">
                                <label>預設字體大小：</label>
                                <input type="number" id="default-font-size" value="${AppState.defaultFontSize || 16}" min="8" max="72" style="width: 60px;">
                            </div>
                            <div class="setting-item">
                                <label>預設線條寬度：</label>
                                <input type="number" id="default-stroke-width" value="${AppState.defaultStrokeWidth || 2}" min="1" max="20" style="width: 60px;">
                            </div>
                            <div class="setting-item">
                                <label>預設顏色：</label>
                                <input type="color" id="default-color" value="${AppState.defaultColor || '#000000'}">
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <h3>效能設定</h3>
                            <div class="setting-item">
                                <label>渲染品質：</label>
                                <select id="render-quality">
                                    <option value="low" ${AppState.renderQuality === 'low' ? 'selected' : ''}>低</option>
                                    <option value="medium" ${AppState.renderQuality === 'medium' ? 'selected' : ''}>中</option>
                                    <option value="high" ${AppState.renderQuality === 'high' ? 'selected' : ''}>高</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>最大歷史記錄數：</label>
                                <input type="number" id="max-history" value="${AppState.maxHistory || 50}" min="10" max="200" style="width: 60px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="saveSettings()">儲存設定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 添加樣式
            const style = document.createElement('style');
            style.textContent = `
                .setting-group {
                    margin-bottom: 20px;
                    padding-bottom: 20px;
                    border-bottom: 1px solid #e0e0e0;
                }
                .setting-group:last-child {
                    border-bottom: none;
                }
                .setting-group h3 {
                    margin-bottom: 15px;
                    color: #333;
                    font-size: 16px;
                }
                .setting-item {
                    margin-bottom: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .setting-item label {
                    flex: 1;
                }
            `;
            modal.appendChild(style);
        }
        
        // 儲存設定
        function saveSettings() {
            AppState.showGrid = document.getElementById('show-grid').checked;
            AppState.showRulers = document.getElementById('show-rulers').checked;
            AppState.autoSave = document.getElementById('auto-save').checked;
            AppState.defaultFontSize = parseInt(document.getElementById('default-font-size').value);
            AppState.defaultStrokeWidth = parseInt(document.getElementById('default-stroke-width').value);
            AppState.defaultColor = document.getElementById('default-color').value;
            AppState.renderQuality = document.getElementById('render-quality').value;
            AppState.maxHistory = parseInt(document.getElementById('max-history').value);
            
            // 儲存到 localStorage
            localStorage.setItem('pdfMasterSettings', JSON.stringify({
                showGrid: AppState.showGrid,
                showRulers: AppState.showRulers,
                autoSave: AppState.autoSave,
                defaultFontSize: AppState.defaultFontSize,
                defaultStrokeWidth: AppState.defaultStrokeWidth,
                defaultColor: AppState.defaultColor,
                renderQuality: AppState.renderQuality,
                maxHistory: AppState.maxHistory
            }));
            
            // 應用設定
            applySettings();
            
            document.querySelector('.modal.active').remove();
            updateStatus('設定已儲存');
        }
        
        // 應用設定
        function applySettings() {
            // 更新渲染品質
            if (AppState.renderQuality && AppState.pdfDoc) {
                const qualityScale = {
                    'low': 1,
                    'medium': 1.5,
                    'high': 2
                };
                AppState.renderScale = qualityScale[AppState.renderQuality] || 1.5;
                renderPage(AppState.currentPage);
            }
            
            // 更新歷史記錄限制
            if (AppState.history && AppState.history.length > AppState.maxHistory) {
                AppState.history = AppState.history.slice(-AppState.maxHistory);
                AppState.historyIndex = AppState.history.length - 1;
            }
        }
        
        // 載入設定
        function loadSettings() {
            const savedSettings = localStorage.getItem('pdfMasterSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                Object.assign(AppState, settings);
            }
        }
        
        // 列印 PDF
        function printPDF() {
            if (!AppState.pdfDoc) {
                alert('請先載入 PDF 檔案');
                return;
            }
            
            updateStatus('正在準備列印...');
            
            // 創建列印用的 iframe
            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'fixed';
            printFrame.style.right = '0';
            printFrame.style.bottom = '0';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            document.body.appendChild(printFrame);
            
            const printDocument = printFrame.contentWindow.document;
            printDocument.open();
            printDocument.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>列印 PDF</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .page { page-break-after: always; }
                            .page:last-child { page-break-after: auto; }
                            img { max-width: 100%; height: auto; }
                        }
                    </style>
                </head>
                <body></body>
                </html>
            `);
            printDocument.close();
            
            // 渲染所有頁面
            const renderPromises = [];
            for (let i = 1; i <= AppState.totalPages; i++) {
                renderPromises.push(renderPageForPrint(i, printDocument.body));
            }
            
            Promise.all(renderPromises).then(() => {
                updateStatus('正在開啟列印對話框...');
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                
                // 列印完成後移除 iframe
                setTimeout(() => {
                    document.body.removeChild(printFrame);
                    updateStatus('列印準備完成');
                }, 1000);
            }).catch(error => {
                console.error('準備列印時發生錯誤:', error);
                alert('準備列印時發生錯誤');
                document.body.removeChild(printFrame);
                updateStatus('列印失敗');
            });
        }
        
        // 為列印渲染頁面
        async function renderPageForPrint(pageNum, container) {
            const page = await AppState.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 2 });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            // 考慮頁面旋轉
            const rotation = AppState.pageRotations && AppState.pageRotations[pageNum] || 0;
            if (rotation !== 0) {
                context.save();
                context.translate(canvas.width / 2, canvas.height / 2);
                context.rotate(rotation * Math.PI / 180);
                context.translate(-canvas.width / 2, -canvas.height / 2);
            }
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            if (rotation !== 0) {
                context.restore();
            }
            
            // 如果有編輯內容，疊加上去
            if (AppState.pages[pageNum] && AppState.pages[pageNum].objects && AppState.pages[pageNum].objects.length > 0) {
                const tempCanvas = new fabric.Canvas(null, {
                    width: viewport.width,
                    height: viewport.height
                });
                
                await new Promise((resolve) => {
                    fabric.util.enlivenObjects(AppState.pages[pageNum].objects, (objects) => {
                        objects.forEach(obj => {
                            obj.scaleX = (obj.scaleX || 1) * (viewport.width / AppState.fabricCanvas.width);
                            obj.scaleY = (obj.scaleY || 1) * (viewport.height / AppState.fabricCanvas.height);
                            obj.left = obj.left * (viewport.width / AppState.fabricCanvas.width);
                            obj.top = obj.top * (viewport.height / AppState.fabricCanvas.height);
                            tempCanvas.add(obj);
                        });
                        tempCanvas.renderAll();
                        resolve();
                    });
                });
                
                context.drawImage(tempCanvas.getElement(), 0, 0);
            }
            
            // 創建頁面容器
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            pageDiv.appendChild(img);
            container.appendChild(pageDiv);
        }
        
        // 搜尋文字功能
        function searchText() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <span>搜尋文字</span>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="search-input" placeholder="輸入要搜尋的文字..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" id="search-case-sensitive">
                                區分大小寫
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" id="search-whole-word">
                                全字匹配
                            </label>
                        </div>
                        <div id="search-results" style="margin-top: 20px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">關閉</button>
                        <button class="btn btn-primary" onclick="performSearch()">搜尋</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 聚焦到搜尋輸入框
            document.getElementById('search-input').focus();
            
            // 按 Enter 鍵搜尋
            document.getElementById('search-input').onkeypress = (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            };
        }
        
        // 執行搜尋
        async function performSearch() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) {
                alert('請輸入搜尋文字');
                return;
            }
            
            const caseSensitive = document.getElementById('search-case-sensitive').checked;
            const wholeWord = document.getElementById('search-whole-word').checked;
            const resultsDiv = document.getElementById('search-results');
            
            resultsDiv.innerHTML = '<p>搜尋中...</p>';
            
            const results = [];
            
            try {
                for (let pageNum = 1; pageNum <= AppState.totalPages; pageNum++) {
                    const page = await AppState.pdfDoc.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    let searchIn = pageText;
                    let searchFor = searchTerm;
                    
                    if (!caseSensitive) {
                        searchIn = searchIn.toLowerCase();
                        searchFor = searchFor.toLowerCase();
                    }
                    
                    if (wholeWord) {
                        const regex = new RegExp(`\\b${searchFor}\\b`, caseSensitive ? 'g' : 'gi');
                        const matches = searchIn.match(regex);
                        if (matches) {
                            results.push({
                                page: pageNum,
                                count: matches.length,
                                preview: getTextPreview(pageText, searchTerm, caseSensitive)
                            });
                        }
                    } else {
                        const index = searchIn.indexOf(searchFor);
                        if (index !== -1) {
                            const count = (searchIn.match(new RegExp(searchFor, 'g')) || []).length;
                            results.push({
                                page: pageNum,
                                count: count,
                                preview: getTextPreview(pageText, searchTerm, caseSensitive)
                            });
                        }
                    }
                }
                
                // 顯示結果
                if (results.length > 0) {
                    resultsDiv.innerHTML = `<p>找到 ${results.length} 個頁面包含 "${searchTerm}"：</p>`;
                    results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.style.cssText = 'padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 4px; cursor: pointer;';
                        resultItem.innerHTML = `
                            <strong>第 ${result.page} 頁</strong> (${result.count} 處匹配)<br>
                            <small style="color: #666;">${result.preview}</small>
                        `;
                        resultItem.onclick = () => {
                            goToPage(result.page);
                            document.querySelector('.modal.active').remove();
                        };
                        resultsDiv.appendChild(resultItem);
                    });
                } else {
                    resultsDiv.innerHTML = `<p>未找到 "${searchTerm}"</p>`;
                }
            } catch (error) {
                console.error('搜尋時發生錯誤:', error);
                resultsDiv.innerHTML = '<p style="color: red;">搜尋時發生錯誤</p>';
            }
        }
        
        // 獲取文字預覽
        function getTextPreview(text, searchTerm, caseSensitive) {
            const searchIn = caseSensitive ? text : text.toLowerCase();
            const searchFor = caseSensitive ? searchTerm : searchTerm.toLowerCase();
            const index = searchIn.indexOf(searchFor);
            
            if (index === -1) return '';
            
            const start = Math.max(0, index - 30);
            const end = Math.min(text.length, index + searchTerm.length + 30);
            let preview = text.substring(start, end);
            
            if (start > 0) preview = '...' + preview;
            if (end < text.length) preview = preview + '...';
            
            return preview;
        }
        
        // 上傳圖片功能
        function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        fabric.Image.fromURL(event.target.result, (img) => {
                            img.set({
                                left: 100,
                                top: 100,
                                scaleX: 0.5,
                                scaleY: 0.5
                            });
                            AppState.fabricCanvas.add(img);
                            saveToHistory();
                            updateStatus('已添加圖片');
                        });
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // 添加印章功能
        function addStamp(type) {
            const stamps = {
                approved: { text: 'APPROVED', color: '#4CAF50' },
                rejected: { text: 'REJECTED', color: '#f44336' },
                confidential: { text: 'CONFIDENTIAL', color: '#FF9800' },
                copy: { text: 'COPY', color: '#2196F3' },
                urgent: { text: 'URGENT', color: '#F44336' },
                paid: { text: 'PAID', color: '#4CAF50' }
            };
            
            const stamp = stamps[type];
            if (!stamp) return;
            
            const text = new fabric.Text(stamp.text, {
                left: 100,
                top: 100,
                fontSize: 48,
                fontWeight: 'bold',
                fill: stamp.color,
                opacity: 0.7,
                angle: -30,
                fontFamily: 'Arial'
            });
            
            AppState.fabricCanvas.add(text);
            saveToHistory();
            updateStatus(`已添加 ${stamp.text} 印章`);
            
            // 關閉模態框
            document.querySelector('.modal.active').classList.remove('active');
        }
        
        // 添加簽名功能
        function addSignature() {
            const modal = document.getElementById('signature-modal');
            modal.classList.add('active');
        }
        
        // 初始化簽名板
        function initializeSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // 設置畫布大小
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // 繪製功能
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = (e.clientX || e.touches[0].clientX) - rect.left;
                lastY = (e.clientY || e.touches[0].clientY) - rect.top;
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = (e.clientX || e.touches[0].clientX) - rect.left;
                const currentY = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            // 滑鼠事件
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // 觸控事件
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', stopDrawing);
            
            // 清除按鈕
            document.getElementById('clear-signature').onclick = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };
            
            // 保存按鈕
            document.getElementById('save-signature').onclick = () => {
                const dataURL = canvas.toDataURL();
                fabric.Image.fromURL(dataURL, (img) => {
                    img.set({
                        left: 100,
                        top: 100,
                        scaleX: 0.5,
                        scaleY: 0.5
                    });
                    AppState.fabricCanvas.add(img);
                    saveToHistory();
                    updateStatus('已添加簽名');
                });
                
                // 關閉模態框
                modal.classList.remove('active');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };
        }
        
        // 高亮文字功能
        function highlightText() {
            AppState.currentTool = 'highlight';
            updateToolState();
            updateStatus('選擇要高亮的區域');
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 載入設定
            loadSettings();
            
            // 當簽名模態框顯示時初始化
            const signatureModal = document.getElementById('signature-modal');
            if (signatureModal) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target.classList.contains('active')) {
                            setTimeout(initializeSignaturePad, 100);
                        }
                    });
                });
                observer.observe(signatureModal, { attributes: true });
            }
        });
    </script>
    
    <!-- 載入 Telegram Bot 模組 -->
    <script src="telegram-bot.js"></script>
</body>
</html>